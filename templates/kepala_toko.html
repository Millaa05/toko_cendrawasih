{% extends "base.html" %} {% block title %}Dashboard Kepala Toko - Toko
Cendrawasih{% endblock %} {% block page_title %}Dashboard Kepala Toko{% endblock
%} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/kepala_toko.css') }}"
/>
{% endblock %} {% block navigation %}
<a href="/kepala_toko/home" class="nav-link active">
  <svg
    width="20"
    height="20"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
  >
    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    <polyline points="9 22 9 12 15 12 15 22"></polyline>
  </svg>
  Dashboard
</a>
{% endblock %} {% block content %}
<div id="alert-container"></div>

<div class="stats-overview">
  <div class="stat-box">
    <div class="stat-header">
      <span class="stat-title">Total Penjualan (30 Hari)</span>
      <div class="stat-icon">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      </div>
    </div>
    <div class="stat-value" id="total-sales">Rp 0</div>
    <div class="stat-change positive" id="sales-trend">Loading...</div>
  </div>

  <div class="stat-box">
    <div class="stat-header">
      <span class="stat-title">Total Pembelian (30 Hari)</span>
      <div class="stat-icon">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path
            d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
          ></path>
        </svg>
      </div>
    </div>
    <div class="stat-value" id="total-purchases">Rp 0</div>
    <div class="stat-change" id="purchase-trend">Loading...</div>
  </div>

  <div class="stat-box">
    <div class="stat-header">
      <span class="stat-title">Estimasi Profit</span>
      <div class="stat-icon">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
      </div>
    </div>
    <div class="stat-value" id="total-profit">Rp 0</div>
    <div class="stat-change positive" id="profit-margin">Loading...</div>
  </div>
</div>

<div class="dashboard-layout">
  <div class="panel">
    <div class="panel-head">
      <h2>Laporan Penjualan Harian</h2>
    </div>
    <div class="panel-body">
      <table class="report-table">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Transaksi</th>
            <th>Total Penjualan</th>
            <th>Rata-rata</th>
          </tr>
        </thead>
        <tbody id="sales-tbody">
          <tr>
            <td
              colspan="4"
              style="text-align: center; padding: 32px; color: #86868b"
            >
              Memuat data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="panel">
    <div class="panel-head">
      <h2>Laporan Pembelian Harian</h2>
    </div>
    <div class="panel-body">
      <table class="report-table">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Batch</th>
            <th>Total Pembelian</th>
            <th>Rata-rata</th>
          </tr>
        </thead>
        <tbody id="purchase-tbody">
          <tr>
            <td
              colspan="4"
              style="text-align: center; padding: 32px; color: #86868b"
            >
              Memuat data...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="panel">
  <div class="panel-head">
    <h2>Pergerakan Stok Barang</h2>
  </div>
  <div class="panel-body">
    <table class="stock-movement-table">
      <thead>
        <tr>
          <th>Kode</th>
          <th>Nama Barang</th>
          <th>Stok Masuk</th>
          <th>Stok Keluar</th>
          <th>Stok Akhir</th>
          <th>Pergerakan</th>
        </tr>
      </thead>
      <tbody id="stock-tbody">
        <tr>
          <td
            colspan="6"
            style="text-align: center; padding: 32px; color: #86868b"
          >
            Memuat data...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  async function loadDailyReport() {
    try {
      const res = await fetch("/kepala_toko/api/daily_report");
      const data = await res.json();

      const salesTbody = document.getElementById("sales-tbody");
      const purchaseTbody = document.getElementById("purchase-tbody");
      const totalSales = document.getElementById("total-sales");
      const totalPurchases = document.getElementById("total-purchases");
      const totalProfit = document.getElementById("total-profit");
      const profitMargin = document.getElementById("profit-margin");

      let sumSales = 0;
      let sumPurchases = 0;

      if (data.sales.length === 0) {
        salesTbody.innerHTML =
          '<tr><td colspan="4" style="text-align: center; padding: 32px; color: #86868b;">Belum ada data penjualan</td></tr>';
      } else {
        salesTbody.innerHTML = data.sales
          .map((s) => {
            sumSales += parseFloat(s.total_penjualan);
            const avg = parseFloat(s.total_penjualan) / s.jumlah_transaksi;
            return `
                    <tr>
                        <td>${s.tanggal}</td>
                        <td>${s.jumlah_transaksi}</td>
                        <td class="amount">Rp ${Number(
                          s.total_penjualan
                        ).toLocaleString("id-ID")}</td>
                        <td>Rp ${Math.round(avg).toLocaleString("id-ID")}</td>
                    </tr>
                `;
          })
          .join("");
      }

      if (data.purchases.length === 0) {
        purchaseTbody.innerHTML =
          '<tr><td colspan="4" style="text-align: center; padding: 32px; color: #86868b;">Belum ada data pembelian</td></tr>';
      } else {
        purchaseTbody.innerHTML = data.purchases
          .map((p) => {
            sumPurchases += parseFloat(p.total_pembelian);
            const avg = parseFloat(p.total_pembelian) / p.jumlah_batch;
            return `
                    <tr>
                        <td>${p.tanggal}</td>
                        <td>${p.jumlah_batch}</td>
                        <td class="amount">Rp ${Number(
                          p.total_pembelian
                        ).toLocaleString("id-ID")}</td>
                        <td>Rp ${Math.round(avg).toLocaleString("id-ID")}</td>
                    </tr>
                `;
          })
          .join("");
      }

      const profit = sumSales - sumPurchases;
      const margin = sumSales > 0 ? ((profit / sumSales) * 100).toFixed(1) : 0;

      totalSales.textContent = `Rp ${Math.round(sumSales).toLocaleString(
        "id-ID"
      )}`;
      totalPurchases.textContent = `Rp ${Math.round(
        sumPurchases
      ).toLocaleString("id-ID")}`;
      totalProfit.textContent = `Rp ${Math.round(profit).toLocaleString(
        "id-ID"
      )}`;
      profitMargin.textContent = `Margin: ${margin}%`;

      document.getElementById(
        "sales-trend"
      ).textContent = `${data.sales.length} hari tercatat`;
      document.getElementById(
        "purchase-trend"
      ).textContent = `${data.purchases.length} hari tercatat`;
    } catch (error) {
      console.error(error);
    }
  }

  async function loadStockChanges() {
    try {
      const res = await fetch("/kepala_toko/api/stock_changes");
      const data = await res.json();

      const tbody = document.getElementById("stock-tbody");

      if (data.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align: center; padding: 32px; color: #86868b;">Belum ada data pergerakan</td></tr>';
        return;
      }

      tbody.innerHTML = data
        .map((d) => {
          const netChange = d.stok_akhir;
          const changeClass =
            netChange > 0 ? "positive" : netChange < 0 ? "negative" : "neutral";
          const changeText = netChange > 0 ? `+${netChange}` : netChange;

          return `
                <tr>
                    <td class="code-cell">${d.kode_barang}</td>
                    <td>${d.nama_barang}</td>
                    <td class="in-stock">+${d.stok_masuk}</td>
                    <td class="out-stock">-${d.stok_keluar}</td>
                    <td><strong>${d.stok_akhir}</strong></td>
                    <td><span class="change-badge ${changeClass}">${changeText}</span></td>
                </tr>
            `;
        })
        .join("");
    } catch (error) {
      console.error(error);
    }
  }

  loadDailyReport();
  loadStockChanges();
  setInterval(loadDailyReport, 30000);
  setInterval(loadStockChanges, 30000);
</script>
{% endblock %}
